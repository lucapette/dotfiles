#!/bin/bash

set -e

die() {
  echo $@
  exit 1
}

usage() {
  cat << EOF
  usage: $0 options
  -r [remote] Show remote merged branches. Active by default. remote defaults
  to origin if not specified.
  -i Ignored branches regex for remotes.
  -l Show local merged. Current branch and master are ignored.
  -h Show this message.
EOF
}

git rev-parse 2> /dev/null || die "It looks like you're not in a git repo."


branch_type='remote'

while getopts "hr:li:" opt
do
  case $opt in
    i)
      exclude_pattern=$OPTARG
      ;;
    l)
      branch_type='local'
      ;;
    r)
      branch_type='remote'
      remote_name=$OPTARG
      ;;
    h)
      usage
      exit
      ;;
    \?)
      echo "Invalid option: -$OPTARG"
      exit 1
      ;;
  esac
done

: ${remote_name:='origin'}
: ${exclude_pattern:='master|ci'}

if [ $branch_type == 'local' ]; then
  git branch --merged | grep -Ev '^\*|master'
else
  git branch -r --merged | grep $remote_name | grep -Ev $exclude_pattern | cut -d '/' -f2
fi
